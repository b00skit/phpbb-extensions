<!-- INCLUDE overall_header.html -->

<h2 class="solo">{{ lang('ADD_AWARD') }}</h2>

<script>
	var form_name = 'add_award_form';
	var text_name = 'comment';
</script>

<form action="{{ U_ACTION }}" method="post" id="add_award_form">
    {% if BOOSKIT_AWARDS_RULESET %}
    <div class="rules">
        <div class="inner">
            <div class="content">{{ BOOSKIT_AWARDS_RULESET|raw }}</div>
        </div>
    </div>
    {% endif %}

	<div class="panel">
		<div class="inner">
			<fieldset>
				<dl>
					<dt><label for="award_definition_id">{{ lang('AWARD_SELECT') }}{{ lang('COLON') }}</label></dt>
					<dd>
						<select name="award_definition_id" id="award_definition_id" onchange="updatePreview()">
							<option value="">{{ lang('SELECT_OPTION') }}</option>
							<!-- BEGIN awards -->
							<option value="{{ awards.ID }}">{{ awards.NAME }}</option>
							<!-- END awards -->
						</select>
					</dd>
				</dl>

                <dl id="preview_container" style="display:none;">
                    <dt><label>Preview:</label></dt>
                    <dd>
                        <div id="award_preview" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; max-width: 200px; text-align: center;">
                            <div id="preview_name" style="font-weight: bold; margin-bottom: 5px;"></div>
                            <img id="preview_image" src="" alt="" style="margin-bottom: 5px;">
                            <div id="preview_desc" style="font-size: 0.9em;"></div>
                        </div>
                    </dd>
                </dl>

				<dl>
					<dt><label for="issue_date">{{ lang('AWARD_DATE') }}{{ lang('COLON') }}</label></dt>
					<dd><input type="date" name="issue_date" id="issue_date" value="{{ S_ISSUE_DATE }}"></dd>
				</dl>

				<dl>
					<dt><label for="comment">{{ lang('AWARD_COMMENT') }}{{ lang('COLON') }}</label></dt>
					<dd><textarea name="comment" id="comment" rows="10" cols="30" class="inputbox" tabindex="3"></textarea></dd>
				</dl>
			</fieldset>
		</div>
	</div>

	<div class="panel" id="public_post_settings" style="display: none;">
		<div class="inner">
			<h3>{{ lang('PUBLIC_POST_SETTINGS') }}</h3>
			<fieldset>
				<dl>
					<dt><label for="make_public_post">{{ lang('MAKE_PUBLIC_POST') }}</label></dt>
					<dd><input type="checkbox" name="make_public_post" id="make_public_post" value="1" /></dd>
				</dl>
				<div id="custom_fields_container" style="display: none;">
					<!-- Dynamic fields injected here -->
				</div>
			</fieldset>
		</div>
	</div>

	<div class="submit-buttons">
		<input type="submit" name="submit" value="{{ lang('SUBMIT') }}" class="button1" />
		{{ S_FORM_TOKEN }}
	</div>
</form>

<script>
var awardsData = {{ AWARDS_JSON | raw }};
var typeSelect = document.getElementById('award_definition_id');
var settingsPanel = document.getElementById('public_post_settings');
var makePublicCheckbox = document.getElementById('make_public_post');
var fieldsContainer = document.getElementById('custom_fields_container');

function updatePreview() {
    var selectedId = typeSelect.value;
    var container = document.getElementById('preview_container');
    var award = null;

    if (selectedId) {
        award = awardsData.find(function(a) { return a.id == selectedId; });
    }

    // Preview Logic
    if (award) {
        document.getElementById('preview_name').textContent = award.name;
        var img = document.getElementById('preview_image');
        img.src = award.image;
        img.alt = award.name;

        if (award['max-width']) img.style.maxWidth = award['max-width'];
        else img.style.maxWidth = '';

        if (award['max-height']) img.style.maxHeight = award['max-height'];
        else img.style.maxHeight = '';

        document.getElementById('preview_desc').textContent = award.description || '';

        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }

    // Public Post Logic
    if (award && award.enable_public_posting) {
        settingsPanel.style.display = 'block';
        updateFields(award);
    } else {
        settingsPanel.style.display = 'none';
        makePublicCheckbox.checked = false;
        fieldsContainer.style.display = 'none';
    }
}

function updateFields(def) {
    var fields = [];
    try {
        if (def.public_posting_fields) {
            fields = JSON.parse(def.public_posting_fields);
        }
    } catch (e) { }

    fieldsContainer.innerHTML = '';

    if (fields.length > 0) {
        fields.forEach(function(field) {
            var dl = document.createElement('dl');
            var dt = document.createElement('dt');
            var label = document.createElement('label');
            label.textContent = field.name;
            dt.appendChild(label);
            if (field.description) {
                var br = document.createElement('br');
                var span = document.createElement('span');
                span.textContent = field.description;
                dt.appendChild(br);
                dt.appendChild(span);
            }

            var dd = document.createElement('dd');
            var input;

            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.name = 'custom_fields[' + field.variable + ']';
                input.className = 'inputbox';
                input.rows = 5;
                if (field.placeholder) input.value = field.placeholder;
            } else if (field.type === 'dropdown') {
                input = document.createElement('select');
                input.name = 'custom_fields[' + field.variable + ']';

                var options = field.placeholder ? field.placeholder.split(',') : [];
                if (options.length === 0) options.push('None');

                options.forEach(function(opt) {
                    var option = document.createElement('option');
                    option.value = opt.trim();
                    option.textContent = opt.trim();
                    input.appendChild(option);
                });
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.name = 'custom_fields[' + field.variable + ']';
                input.className = 'inputbox';
                if (field.placeholder) input.value = field.placeholder;
            }

            dd.appendChild(input);
            dl.appendChild(dt);
            dl.appendChild(dd);
            fieldsContainer.appendChild(dl);
        });
    }
}

makePublicCheckbox.addEventListener('change', function() {
    if (this.checked) {
        fieldsContainer.style.display = 'block';
    } else {
        fieldsContainer.style.display = 'none';
    }
});
</script>

<!-- INCLUDE overall_footer.html -->
