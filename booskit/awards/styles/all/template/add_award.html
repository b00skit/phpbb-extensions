<!-- INCLUDE overall_header.html -->

<h2 class="solo">{{ lang('ADD_AWARD') }}</h2>

<script>
	var form_name = 'add_award_form';
	var text_name = 'comment';
</script>

<form action="{{ U_ACTION }}" method="post" id="add_award_form">
    {% if BOOSKIT_AWARDS_RULESET %}
    <div class="rules">
        <div class="inner">
            <div class="content">{{ BOOSKIT_AWARDS_RULESET|raw }}</div>
        </div>
    </div>
    {% endif %}

	<div class="panel">
		<div class="inner">
			<fieldset>
				<dl>
					<dt><label for="award_definition_id">{{ lang('AWARD_SELECT') }}{{ lang('COLON') }}</label></dt>
					<dd>
						<select name="award_definition_id" id="award_definition_id">
							<option value="">{{ lang('SELECT_OPTION') }}</option>
							<!-- BEGIN awards -->
							<option value="{{ awards.ID }}">{{ awards.NAME }}</option>
							<!-- END awards -->
						</select>
					</dd>
				</dl>

                <dl id="preview_container" style="display:none;">
                    <dt><label>Preview:</label></dt>
                    <dd>
                        <div id="award_preview" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; max-width: 200px; text-align: center;">
                            <div id="preview_name" style="font-weight: bold; margin-bottom: 5px;"></div>
                            <img id="preview_image" src="" alt="" style="margin-bottom: 5px;">
                            <div id="preview_desc" style="font-size: 0.9em;"></div>
                        </div>
                    </dd>
                </dl>

				<dl>
					<dt><label for="issue_date">{{ lang('AWARD_DATE') }}{{ lang('COLON') }}</label></dt>
					<dd><input type="date" name="issue_date" id="issue_date" value="{{ S_ISSUE_DATE }}"></dd>
				</dl>

				<dl>
					<dt><label for="comment">{{ lang('AWARD_COMMENT') }}{{ lang('COLON') }}</label></dt>
					<dd><textarea name="comment" id="comment" rows="10" cols="30" class="inputbox" tabindex="3"></textarea></dd>
				</dl>
			</fieldset>
		</div>
	</div>

	<div class="panel" id="public_post_settings" style="display: none;">
		<div class="inner">
			<h3>{{ lang('PUBLIC_POST_SETTINGS') }}</h3>
			<fieldset>
				<dl>
					<dt><label for="make_public_post">{{ lang('MAKE_PUBLIC_POST') }}</label></dt>
					<dd><input type="checkbox" name="make_public_post" id="make_public_post" value="1" /></dd>
				</dl>
				<div id="custom_fields_container" style="display: none;">
					<!-- Dynamic fields injected here -->
				</div>
			</fieldset>
		</div>
	</div>

	<div class="submit-buttons">
		<input type="submit" name="submit" value="{{ lang('SUBMIT') }}" class="button1" />
		{{ S_FORM_TOKEN }}
	</div>
</form>

<script>
(function() {
    var awardsData = {{ AWARDS_JSON | raw }};

    function updatePreview() {
        var typeSelect = document.getElementById('award_definition_id');
        var settingsPanel = document.getElementById('public_post_settings');
        var makePublicCheckbox = document.getElementById('make_public_post');
        var fieldsContainer = document.getElementById('custom_fields_container');
        var previewContainer = document.getElementById('preview_container');
        var previewName = document.getElementById('preview_name');
        var previewImage = document.getElementById('preview_image');
        var previewDesc = document.getElementById('preview_desc');

        var selectedId = typeSelect ? typeSelect.value : '';
        var award = null;

        if (selectedId && awardsData) {
            for (var key in awardsData) {
                if (awardsData.hasOwnProperty(key)) {
                    var a = awardsData[key];
                    if (a.id == selectedId) {
                        award = a;
                        break;
                    }
                }
            }
        }

        // Preview Logic
        if (award && previewContainer) {
            if (previewName) previewName.textContent = award.name;
            if (previewImage) {
                previewImage.src = award.image;
                previewImage.alt = award.name;

                if (award['max-width']) previewImage.style.maxWidth = award['max-width'];
                else previewImage.style.maxWidth = '';

                if (award['max-height']) previewImage.style.maxHeight = award['max-height'];
                else previewImage.style.maxHeight = '';
            }
            if (previewDesc) previewDesc.textContent = award.description || '';

            previewContainer.style.display = 'block';
        } else if (previewContainer) {
            previewContainer.style.display = 'none';
        }

        // Public Post Logic
        if (award && award.enable_public_posting) {
            if (settingsPanel) settingsPanel.style.display = 'block';
            updateFields(award);
        } else {
            if (settingsPanel) settingsPanel.style.display = 'none';
            if (makePublicCheckbox) makePublicCheckbox.checked = false;
            if (fieldsContainer) fieldsContainer.style.display = 'none';
        }
    }

    function updateFields(def) {
        var fieldsContainer = document.getElementById('custom_fields_container');
        var makePublicCheckbox = document.getElementById('make_public_post');

        if (!fieldsContainer) return;

        var fields = [];
        try {
            if (def.public_posting_fields) {
                fields = JSON.parse(def.public_posting_fields);
            }
        } catch (e) {
            console.error('Error parsing fields JSON', e);
        }

        fieldsContainer.innerHTML = '';

        if (fields.length > 0) {
            fields.forEach(function(field) {
                var dl = document.createElement('dl');
                var dt = document.createElement('dt');
                var label = document.createElement('label');
                label.textContent = field.name;
                dt.appendChild(label);
                if (field.description) {
                    var br = document.createElement('br');
                    var span = document.createElement('span');
                    span.textContent = field.description;
                    dt.appendChild(br);
                    dt.appendChild(span);
                }

                var dd = document.createElement('dd');
                var input;

                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.name = 'custom_fields[' + field.variable + ']';
                    input.className = 'inputbox';
                    input.rows = 5;
                    if (field.placeholder) input.value = field.placeholder;
                } else if (field.type === 'dropdown') {
                    input = document.createElement('select');
                    input.name = 'custom_fields[' + field.variable + ']';

                    var options = field.placeholder ? field.placeholder.split(',') : [];
                    if (options.length === 0) options.push('None');

                    options.forEach(function(opt) {
                        var option = document.createElement('option');
                        option.value = opt.trim();
                        option.textContent = opt.trim();
                        input.appendChild(option);
                    });
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.name = 'custom_fields[' + field.variable + ']';
                    input.className = 'inputbox';
                    if (field.placeholder) input.value = field.placeholder;
                }

                dd.appendChild(input);
                dl.appendChild(dt);
                dl.appendChild(dd);
                fieldsContainer.appendChild(dl);
            });

            // Restore visibility if checkbox is checked
            if (makePublicCheckbox && makePublicCheckbox.checked) {
                fieldsContainer.style.display = 'block';
            }
        }
    }

    function init() {
        if (typeof jQuery !== 'undefined') {
            jQuery('#award_definition_id').on('change', updatePreview);
            jQuery('#make_public_post').on('change', function() {
                var fieldsContainer = document.getElementById('custom_fields_container');
                if (this.checked) {
                    if (fieldsContainer) fieldsContainer.style.display = 'block';
                } else {
                    if (fieldsContainer) fieldsContainer.style.display = 'none';
                }
            });
        } else {
            var typeSelect = document.getElementById('award_definition_id');
            var makePublicCheckbox = document.getElementById('make_public_post');

            if (typeSelect) {
                typeSelect.addEventListener('change', updatePreview);
            }
            if (makePublicCheckbox) {
                makePublicCheckbox.addEventListener('change', function() {
                    var fieldsContainer = document.getElementById('custom_fields_container');
                    if (this.checked) {
                        if (fieldsContainer) fieldsContainer.style.display = 'block';
                    } else {
                        if (fieldsContainer) fieldsContainer.style.display = 'none';
                    }
                });
            }
        }

        updatePreview();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>

<!-- INCLUDE overall_footer.html -->
