{% INCLUDE 'overall_header.html' %}

<a href="{{ U_BACK }}" class="arrow-{{ S_CONTENT_FLOW_BEGIN }}">{{ lang('BACK') }}</a>

<script>
	var form_name = 'postform';
	var text_name = 'description';
</script>

<form id="postform" method="post" action="{{ U_ACTION }}">

    {% if BOOSKIT_CAREER_RULESET %}
    <div class="rules">
        <div class="inner">
            <div class="content">{{ BOOSKIT_CAREER_RULESET|raw }}</div>
        </div>
    </div>
    {% endif %}

<div class="panel">
	<div class="inner">
		<h3>{{ PAGE_TITLE }}</h3>

		<fieldset>
			<dl>
				<dt><label for="career_type_id">{{ lang('CAREER_TYPE') }}</label></dt>
				<dd>
					<select name="career_type_id" id="career_type_id">
						{% for type in types %}
						<option value="{{ type.ID }}"{% if type.SELECTED %} selected="selected"{% endif %}>{{ type.NAME }}</option>
						{% endfor %}
					</select>
				</dd>
			</dl>
			<dl>
				<dt><label for="note_date">{{ lang('CAREER_DATE') }}</label></dt>
				<dd><input type="date" name="note_date" id="note_date" value="{{ S_NOTE_DATE }}" class="inputbox" /></dd>
			</dl>

			<dl>
				<dt><label for="description">{{ lang('CAREER_DESCRIPTION') }}</label></dt>
				<dd><textarea name="description" id="description" rows="10" cols="45" class="inputbox" tabindex="3">{{ DESCRIPTION }}</textarea></dd>
			</dl>
		</fieldset>
	</div>
</div>

<div class="panel" id="public_post_settings" style="display: none;">
	<div class="inner">
		<h3>{{ lang('PUBLIC_POST_SETTINGS') }}</h3>
		<fieldset>
			<dl>
				<dt><label for="make_public_post">{{ lang('MAKE_PUBLIC_POST') }}</label></dt>
				<dd><input type="checkbox" name="make_public_post" id="make_public_post" value="1" /></dd>
			</dl>
			<div id="custom_fields_container" style="display: none;">
				<!-- Dynamic fields injected here -->
			</div>
		</fieldset>
	</div>
</div>

<div class="panel" id="group_action_settings" style="display: none;">
	<div class="inner">
		<h3>{{ lang('FORUM_GROUP_ACTIONS') }}</h3>
		<fieldset>
			<dl>
				<dt><label for="execute_group_action">{{ lang('ENABLE_GROUP_ACTION') }}</label></dt>
				<dd><input type="checkbox" name="execute_group_action" id="execute_group_action" value="1" /></dd>
			</dl>
			<div id="group_action_details">
				<dl>
					<dt>{{ lang('GROUPS_ADD') }}{{ lang('COLON') }}</dt>
					<dd id="groups_add_list"></dd>
				</dl>
				<dl>
					<dt>{{ lang('GROUPS_REMOVE') }}{{ lang('COLON') }}</dt>
					<dd id="groups_remove_list"></dd>
				</dl>
			</div>
		</fieldset>
	</div>
</div>

<div class="panel">
	<div class="inner">
		<fieldset class="submit-buttons">
			{{ S_FORM_TOKEN }}
			<input type="submit" accesskey="s" tabindex="6" name="submit" value="{{ lang('SUBMIT') }}" class="button1" />&nbsp;
		</fieldset>
	</div>
</div>

</form>

<script>
(function() {
	var definitions = {{ DEFINITIONS_JSON|raw }};
	var groupNames = {{ GROUP_NAMES_JSON|raw }};

	function getDefinition(id) {
        if (!definitions) return null;
        for (var key in definitions) {
            if (definitions.hasOwnProperty(key)) {
                var def = definitions[key];
                if (def.id == id) {
                    return def;
                }
            }
        }
		return null;
	}

	function updateVisibility() {
        var typeSelect = document.getElementById('career_type_id');
        var settingsPanel = document.getElementById('public_post_settings');
        var makePublicCheckbox = document.getElementById('make_public_post');
        var fieldsContainer = document.getElementById('custom_fields_container');
        var groupActionPanel = document.getElementById('group_action_settings');
        var executeGroupActionCheckbox = document.getElementById('execute_group_action');

		var selectedId = typeSelect ? typeSelect.value : '';
		var def = getDefinition(selectedId);

		// Public Posting
		if (def && def.enable_public_posting) {
			if (settingsPanel) settingsPanel.style.display = 'block';
			updateFields(def);
		} else {
			if (settingsPanel) settingsPanel.style.display = 'none';
			if (makePublicCheckbox) makePublicCheckbox.checked = false;
			if (fieldsContainer) fieldsContainer.style.display = 'none';
		}

		// Group Actions
		if (def && def.enable_group_action) {
			if (groupActionPanel) groupActionPanel.style.display = 'block';
			updateGroupLists(def);
		} else {
			if (groupActionPanel) groupActionPanel.style.display = 'none';
			if (executeGroupActionCheckbox) executeGroupActionCheckbox.checked = false;
		}
	}

	function getGroupName(id) {
		return groupNames[id] ? groupNames[id] : 'ID: ' + id;
	}

	function updateGroupLists(def) {
        var groupsAddList = document.getElementById('groups_add_list');
        var groupsRemoveList = document.getElementById('groups_remove_list');

		var addStr = String(def.group_action_add || '');
		var removeStr = String(def.group_action_remove || '');

		var addList = [];
		if (addStr) {
			addStr.split(',').forEach(function(id) {
				id = id.trim();
				if (id) addList.push(getGroupName(id));
			});
		}
        if (groupsAddList) groupsAddList.textContent = addList.length ? addList.join(', ') : 'None';

		var removeList = [];
		if (removeStr) {
			removeStr.split(',').forEach(function(id) {
				id = id.trim();
				if (id === '*') {
					removeList.push('All (Except Admins/Global Mods)');
				} else if (id) {
					removeList.push(getGroupName(id));
				}
			});
		}
        if (groupsRemoveList) groupsRemoveList.textContent = removeList.length ? removeList.join(', ') : 'None';
	}

	function updateFields(def) {
        var fieldsContainer = document.getElementById('custom_fields_container');
        var makePublicCheckbox = document.getElementById('make_public_post');

        if (!fieldsContainer) return;

		var fields = [];
		try {
			if (def.public_posting_fields) {
				fields = JSON.parse(def.public_posting_fields);
			}
		} catch (e) {
            console.error('Error parsing fields JSON', e);
        }

		fieldsContainer.innerHTML = '';

		if (fields.length > 0) {
			fields.forEach(function(field) {
				var dl = document.createElement('dl');
				var dt = document.createElement('dt');
				var label = document.createElement('label');
				label.textContent = field.name;
				dt.appendChild(label);
				if (field.description) {
					var br = document.createElement('br');
					var span = document.createElement('span');
					span.textContent = field.description;
					dt.appendChild(br);
					dt.appendChild(span);
				}

				var dd = document.createElement('dd');
				var input;

				if (field.type === 'textarea') {
					input = document.createElement('textarea');
					input.name = 'custom_fields[' + field.variable + ']';
					input.className = 'inputbox';
					input.rows = 5;
					if (field.placeholder) input.value = field.placeholder;
				} else if (field.type === 'dropdown') {
					input = document.createElement('select');
					input.name = 'custom_fields[' + field.variable + ']';

					var options = field.placeholder ? field.placeholder.split(',') : [];
					if (options.length === 0) options.push('None');

					options.forEach(function(opt) {
						var option = document.createElement('option');
						option.value = opt.trim();
						option.textContent = opt.trim();
						input.appendChild(option);
					});
				} else {
					input = document.createElement('input');
					input.type = 'text';
					input.name = 'custom_fields[' + field.variable + ']';
					input.className = 'inputbox';
					if (field.placeholder) input.value = field.placeholder;
				}

				dd.appendChild(input);
				dl.appendChild(dt);
				dl.appendChild(dd);
				fieldsContainer.appendChild(dl);
			});

            if (makePublicCheckbox && makePublicCheckbox.checked) {
                fieldsContainer.style.display = 'block';
            }
		}
	}

    document.addEventListener('change', function(e) {
        if (!e.target) return;

        if (e.target.id === 'career_type_id') {
            updateVisibility();
        } else if (e.target.id === 'make_public_post') {
            var fieldsContainer = document.getElementById('custom_fields_container');
		if (e.target.checked) {
			if (fieldsContainer) fieldsContainer.style.display = 'block';
		} else {
			if (fieldsContainer) fieldsContainer.style.display = 'none';
		}
        }
    });

	// Initial state
	updateVisibility();
})();
</script>

{% INCLUDE 'overall_footer.html' %}
